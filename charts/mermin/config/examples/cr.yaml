---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminAgentTraces
metadata:
  name: main
spec:
  associationSource: # ObjectReference or MerminAssociationK8sFlowAttributes.spec contents
    objectReference:
      name: source # MerminAssociationK8sFlowAttributes kind implicitly
  associationDestination: # ObjectReference or MerminAssociationK8sFlowAttributes.spec contents
    objectReference:
      name: destination # MerminAssociationK8sFlowAttributes kind implicitly
  discoveryOwner: # ObjectReference or MerminDiscoveryKubernetesOwner.spec contents
    objectReference:
      name: main # MerminDiscoveryKubernetesOwner kind implicitly
  discoverySelector: # ObjectReference or MerminDiscoveryKubernetesSelector.spec contents
    objectReference:
      name: main # MerminDiscoveryKubernetesSelector kind implicitly
  networkConnection: # ObjectReference or MerminFlowConnection.spec contents
    objectReference:
      name: main # MerminFlowConnection kind implicitly
  networkInterface:
    includeNames: []
    excludeNames: []
  source: # ObjectReference or MerminFlowSpan.spec contents
    objectReference:
      name: source # MerminFlowSpan kind implicitly
  destination: # ObjectReference or MerminFlowSpan.spec contents
    objectReference:
      name: destination # MerminFlowSpan kind implicitly
  includeNetworkTransports: []
  excludeNetworkTransports: []
  includeNetworkTypes: []
  excludeNetworkTypes: []
  exporters:
    - kind: MerminExporterStdout
      name: json
    - kind: MerminExporterOTLP
      name: main
  k8s:
    selectors:
      - kind: Service
      - kind: Endpoint
      - kind: EndpointSlice
      - kind: Gateway
      - kind: Ingress
      - kind: Pod
      - kind: ReplicaSet
      - kind: Deployment
      - kind: Daemonset
      - kind: StatefulSet
      - kind: Job
      - kind: CronJob
      - kind: NetworkPolicy

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminFlowConnection
metadata:
  name: main
spec:
  includeStates: []
  excludeStates: []

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminFlowSpan
metadata:
  name: source
spec:
  includeCIDRs: []
  excludeCIDRs: []
  includePorts: []
  excludePorts: []

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminFlowSpan
metadata:
  name: destination
spec:
  includeCIDRs: []
  excludeCIDRs: []
  includePorts: []
  excludePorts: []

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminAssociationK8sFlowAttributes
metadata:
  name: destination
spec:
  association:
    - sources:
        - from: flow
          name: destination.ip
          to:
            - pod.status.podIP
            - pod.status.podIPs[*]
            - pod.status.hostIP
            - pod.status.hostIPs[*]
        - from: flow
          name: destination.port
          to:
            - pod.spec.containers[*].ports[*].containerPort
            - pod.spec.containers[*].ports[*].hostPort
        - from: flow
          name: network.transport
          to:
            - pod.spec.containers[*].ports[*].protocol
    - sources:
        - from: flow
          name: destination.ip
          to:
            - node.status.addresses[*].address
    - sources:
        - from: flow
          name: destination.ip
          to:
            - service.spec.clusterIP
            - service.spec.clusterIPs[*]
            - service.spec.externalIPs[*]
            - service.spec.loadBalancerIP
            - service.spec.externalName
        - from: flow
          name: destination.port
          to:
            - service.spec.ports[*].port
        - from: flow
          name: network.transport
          to:
            - service.spec.ports[*].protocol
        - from: flow
          name: network.type
          to:
            - service.spec.ipFamilies[*]
    - sources:
        - from: flow
          name: destination.ip
          to:
            - endpoint.subsets[*].addresses[*].ip
        - from: flow
          name: destination.port
          to:
            - endpoint.subsets[*].ports[*].port
        - from: flow
          name: network.transport
          to:
            - endpoint.subsets[*].ports[*].protocol
    - sources:
        - from: flow
          name: destination.ip
          to:
            - endpointslice.endpoints[*].addresses[*]
        - from: flow
          name: destination.port
          to:
            - endpointslice.ports[*].port
        - from: flow
          name: network.transport
          to:
            - endpointslice.ports[*].protocol
    - sources:
        - from: flow
          name: destination.ip
          to:
            - ingress.status.loadBalancer.ingress[*].ip
            - ingress.status.loadBalancer.ingress[*].hostname
        - from: flow
          name: destination.port
          to:
            - ingress.spec.defaultBackend.service.port
            - ingress.spec.rules[*].http.paths[*].backend.service.port.number
    - sources:
        - from: flow
          name: destination.ip
          to:
            - gateway.spec.addresses[*].value
            - gateway.status.addresses[*].value
        - from: flow
          name: destination.port
          to:
            - gateway.spec.listeners[*].port
    - sources:
        - from: flow
          name: destination.ip
          to:
            - networkpolicy.spec.ingress[*].from[*].ipBlock.cidr
            - networkpolicy.spec.egress[*].to[*].ipBlock.cidr
        - from: flow
          name: destination.port
          to:
            - networkpolicy.spec.ingress[*].ports[*].port
            - networkpolicy.spec.egress[*].ports[*].port
        - from: flow
          name: network.transport
          to:
            - networkpolicy.spec.ingress[*].ports[*].protocol
            - networkpolicy.spec.egress[*].ports[*].protocol
  extract:
    metadata:
      - "[*].metadata.name"
      - "[*].metadata.namespace"
      - pod.metadata.uid

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminDiscoveryKubernetesOwner
metadata:
  name: main
spec:
  includeKinds:
    - Service
  excludeKinds:
    - EndpointSlice
  maxDepth: 5
  walkMaxDepth: 10

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminDiscoveryKubernetesSelector
metadata:
  name: main
spec:
  k8sObject:
    - kind: NetworkPolicy
      selectorMatchExpressionsField: spec.podSelector.matchExpressions
      selectorMatchLabelsField: spec.podSelector.matchLabels
      to: Pod
    - kind: Service
      selectorMatchLabelsField: spec.selector
      to: Pod

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminExporterStdout
metadata:
  name: json
spec:
  format: json

---
apiVersion: mermin.elastiflow.com/mermin.elastiflow.com/v1alpha1
kind: MerminExporterOTLP
metadata:
  name: main
spec:
  address: example.com
  auth:
    basic:
      pass: env("USER_SPECIFIED_ENV_VAR_TRITON_PASS")
      user: foo
  port: 443
  tls:
    caCert: /etc/certs/ca.crt
    clientCert: /etc/certs/cert.crt
    clientKey: /etc/certs/cert.key
    enabled: true
    insecure: false
