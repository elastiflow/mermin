apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mermin.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mermin.labels" . | nindent 4 }}
data:
  mermin-config.yaml: |
    {{- with .Values.config }}
    # Network interfaces to monitor
    interface:
      {{- toYaml .interface | nindent 6 }}

    # Logging configuration
    log_level: {{ .log_level | default "info" }}

    # Automatic configuration reloading
    auto_reload: {{ .auto_reload | default false }}

    # API server configuration
    api:
      enabled: true
      {{- with .api }}
      listen_address: {{ .listenAddress | default "0.0.0.0" | quote }}
      {{- end }}
      {{- range $.Values.ports }}
      {{- if eq .name "api" }}
      port: {{ .containerPort }}
      {{- end }}
      {{- end }}

    # Metrics server configuration
    metrics:
      enabled: true
      {{- with .metrics }}
      listen_address: {{ .listenAddress | default "0.0.0.0" | quote }}
      {{- end }}
      {{- range $.Values.ports }}
      {{- if eq .name "metrics" }}
      port: {{ .containerPort }}
      {{- end }}
      {{- end }}

    # Pipeline configuration
    packet_channel_capacity: {{ .packet_channel_capacity | default 1024 }}
    packet_worker_count: {{ .packet_worker_count | default 2 }}
    shutdown_timeout: {{ .shutdown_timeout | default "5s" }}

    # Span/Flow configuration
    span:
      max_batch_size: {{ .span.max_batch_size | default 64 }}
      max_batch_interval: {{ .span.max_batch_interval | default "5s" }}
      max_record_interval: {{ .span.max_record_interval | default "60s" }}
      generic_timeout: {{ .span.generic_timeout | default "30s" }}
      icmp_timeout: {{ .span.icmp_timeout | default "10s" }}
      tcp_timeout: {{ .span.tcp_timeout | default "20s" }}
      tcp_fin_timeout: {{ .span.tcp_fin_timeout | default "5s" }}
      tcp_rst_timeout: {{ .span.tcp_rst_timeout | default "5s" }}
      udp_timeout: {{ .span.udp_timeout | default "60s" }}

    # Agent configuration - specify which exporters are enabled
    agent:
      traces:
        main:
          exporters:
            {{- if .exporter.otlp_enabled }}
            - exporter.otlp.main
            {{- end }}
            {{- if .exporter.stdout_enabled }}
            - exporter.stdout.json
            {{- end }}

    # Exporter configuration
    exporter:
      {{- with .exporter }}
      {{- if .otlp_enabled }}
      otlp:
        main:
          address: {{ .otlp_address | default "example.com" | quote }}
          {{- with .otlp_auth }}
          auth:
            basic:
              pass: {{ .basic_pass | default "env(\"USER_SPECIFIED_ENV_VAR_TRITON_PASS\")" | quote }}
              user: {{ .basic_user | default "foo" | quote }}
          {{- end }}
          port: {{ .otlp_port | default 443 }}
          {{- with .otlp_tls }}
          tls:
            ca_cert: {{ .ca_cert | default "/etc/certs/ca.crt" | quote }}
            client_cert: {{ .client_cert | default "/etc/certs/cert.crt" | quote }}
            client_key: {{ .client_key | default "/etc/certs/cert.key" | quote }}
            enabled: {{ .enabled | default true }}
            insecure: {{ .insecure | default false }}
          {{- else }}
          tls:
            ca_cert: "/etc/certs/ca.crt"
            client_cert: "/etc/certs/cert.crt"
            client_key: "/etc/certs/cert.key"
            enabled: true
            insecure: false
          {{- end }}
      {{- end }}
      {{- if .stdout_enabled }}
      stdout:
        {{- with .stdout }}
        json:
          format: {{ .json_format | default "full" | quote }}
        console:
          format: {{ .console_format | default "compact" | quote }}
        {{- else }}
        json:
          format: "full"
        console:
          format: "compact"
        {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
