apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mermin.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mermin.labels" . | nindent 4 }}
data:
  mermin-config.yaml: |
    {{- with .Values.config }}
    # Network interfaces to monitor
    interface:
      {{- toYaml .interface | nindent 6 }}

    # Logging configuration
    log_level: {{ .log_level | default "info" }}

    # Automatic configuration reloading
    auto_reload: {{ .auto_reload | default false }}

    # API server configuration
    api:
      enabled: true
      {{- with .api }}
      listen_address: {{ .listenAddress | default "0.0.0.0" | quote }}
      {{- end }}
      {{- range $.Values.ports }}
      {{- if eq .name "api" }}
      port: {{ .containerPort }}
      {{- end }}
      {{- end }}

    # Metrics server configuration
    metrics:
      enabled: true
      {{- with .metrics }}
      listen_address: {{ .listenAddress | default "0.0.0.0" | quote }}
      {{- end }}
      {{- range $.Values.ports }}
      {{- if eq .name "metrics" }}
      port: {{ .containerPort }}
      {{- end }}
      {{- end }}

    # Pipeline configuration
    packet_channel_capacity: {{ .packet_channel_capacity | default 1024 }}
    packet_worker_count: {{ .packet_worker_count | default 2 }}
    shutdown_timeout: {{ .shutdown_timeout | default "5s" }}

    # Span/Flow configuration
    span:
      max_batch_size: {{ .span.max_batch_size | default 64 }}
      max_batch_interval: {{ .span.max_batch_interval | default "5s" }}
      max_record_interval: {{ .span.max_record_interval | default "60s" }}
      generic_timeout: {{ .span.generic_timeout | default "30s" }}
      icmp_timeout: {{ .span.icmp_timeout | default "10s" }}
      tcp_timeout: {{ .span.tcp_timeout | default "20s" }}
      tcp_fin_timeout: {{ .span.tcp_fin_timeout | default "5s" }}
      tcp_rst_timeout: {{ .span.tcp_rst_timeout | default "5s" }}
      udp_timeout: {{ .span.udp_timeout | default "60s" }}

    # Exporter configuration
    exporters:
      {{- if .exporter.stdout_enabled }}
      - name: "stdout"
        enabled: true
        exporter_type: "Stdout"
        config:
          Stdout:
            format: "json"
      {{- end }}
      {{- if .exporter.otlp_enabled }}
      - name: "otlp"
        enabled: true
        exporter_type: "Otlp"
        config:
          Otlp:
            endpoint: {{ .exporter.otlp_endpoint | default "http://host.docker.internal:4317" | quote }}
            timeout_seconds: {{ .exporter.otlp_timeout_seconds | default 3 }}
            protocol: {{ .exporter.otlp_protocol | default "grpc" | quote }}
            headers: null
            batch_size: null
            auth: null
      {{- end }}
    {{- end }}
