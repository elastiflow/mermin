apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mermin.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mermin.labels" . | nindent 4 }}
data:
  mermin-config.yaml: |
    {{- with .Values.config }}
    # Network interfaces to monitor
    interface:
      {{- toYaml .interface | nindent 6 }}

    # Logging configuration
    log_level: {{ .log_level | default "info" }}

    # Automatic configuration reloading
    auto_reload: {{ .auto_reload | default false }}

    # API server configuration
    api:
      enabled: true
      {{- with .api }}
      listen_address: {{ .listenAddress | default "0.0.0.0" | quote }}
      {{- end }}
      {{- range $.Values.ports }}
      {{- if eq .name "api" }}
      port: {{ .containerPort }}
      {{- end }}
      {{- end }}

    # Metrics server configuration
    metrics:
      enabled: true
      {{- with .metrics }}
      listen_address: {{ .listenAddress | default "0.0.0.0" | quote }}
      {{- end }}
      {{- range $.Values.ports }}
      {{- if eq .name "metrics" }}
      port: {{ .containerPort }}
      {{- end }}
      {{- end }}

    # Pipeline configuration
    packet_channel_capacity: {{ .packet_channel_capacity | default 1024 }}
    packet_worker_count: {{ .packet_worker_count | default 2 }}
    shutdown_timeout: {{ .shutdown_timeout | default "5s" }}

    # Span/Flow configuration
    span:
      max_batch_size: {{ .span.max_batch_size | default 64 }}
      max_batch_interval: {{ .span.max_batch_interval | default "5s" }}
      max_record_interval: {{ .span.max_record_interval | default "60s" }}
      generic_timeout: {{ .span.generic_timeout | default "30s" }}
      icmp_timeout: {{ .span.icmp_timeout | default "10s" }}
      tcp_timeout: {{ .span.tcp_timeout | default "20s" }}
      tcp_fin_timeout: {{ .span.tcp_fin_timeout | default "5s" }}
      tcp_rst_timeout: {{ .span.tcp_rst_timeout | default "5s" }}
      udp_timeout: {{ .span.udp_timeout | default "60s" }}

    # Exporter configuration
    exporter:
      {{- if .exporter.otlp }}
      otlp:
        {{- with .exporter.otlp }}
        {{- if .main }}
        main:
          address: {{ .main.address | default "host.docker.internal" | quote }}
          port: {{ .main.port | default 4317 }}
          protocol: {{ .main.protocol | default "grpc" | quote }}
          timeout: {{ .main.timeout | default "3s" | quote }}
          {{- if .main.auth }}
          auth:
            {{- toYaml .main.auth | nindent 12 }}
          {{- end }}
          {{- if .main.tls }}
          tls:
            {{- toYaml .main.tls | nindent 12 }}
          {{- end }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- if .exporter.stdout }}
      stdout:
        {{- with .exporter.stdout }}
        {{- if .json }}
        json:
          format: {{ .json.format | default "json" | quote }}
        {{- end }}
        {{- end }}
      {{- end }}

    # Agent configuration
    {{- if .agent }}
    agent:
      {{- if .agent.traces }}
      traces:
        {{- if .agent.traces.main }}
        main:
          discovery_owner: {{ .agent.traces.main.discovery_owner | default "discovery.k8s_owner.main" | quote }}
          discovery_selector: {{ .agent.traces.main.discovery_selector | default "discovery.k8s_selector.main" | quote }}
          exporters:
            {{- with .agent.traces.main.exporters }}
            {{- toYaml . | nindent 12 }}
            {{- else }}
            - "exporter.stdout.json"
            {{- if .exporter.otlp.main }}
            - "exporter.otlp.main"
            {{- end }}
            {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    # Discovery configuration
    {{- if .discovery }}
    discovery:
      {{- if .discovery.k8s_owner }}
      k8s_owner:
        {{- if .discovery.k8s_owner.main }}
        main:
          exclude_kinds:
            {{- with .discovery.k8s_owner.main.exclude_kinds }}
            {{- toYaml . | nindent 12 }}
            {{- else }}
            - EndpointSlice
            - "*"
            {{- end }}
          include_kinds:
            {{- with .discovery.k8s_owner.main.include_kinds }}
            {{- toYaml . | nindent 12 }}
            {{- else }}
            - Service
            {{- end }}
          max_depth: {{ .discovery.k8s_owner.main.max_depth | default 5 }}
        {{- end }}
      {{- end }}
      {{- if .discovery.k8s_selector }}
      k8s_selector:
        {{- if .discovery.k8s_selector.main }}
        main:
          k8s_object:
            {{- with .discovery.k8s_selector.main.k8s_object }}
            {{- toYaml . | nindent 12 }}
            {{- else }}
            - kind: NetworkPolicy
              selector_match_expressions_field: spec.podSelector.matchExpressions
              selector_match_labels_field: spec.podSelector.matchLabels
              to: Pod
            - kind: Service
              selector_match_labels_field: spec.selector
              to: Pod
            {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- end }}
