---
alwaysApply: true
---

# Quick Reference: Common Mermin Development Commands

## Essential Commands

### Setup

```bash
# Build development container
docker build -t mermin-builder:latest --target builder .

# Verify container
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo --version && bpftool --version"
```

### Building

```bash
# Clean build
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clean && cargo build"

# Release build
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build --release"

# Build specific crate
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build -p mermin-ebpf"
```

### Testing

```bash
# All tests
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo test"

# eBPF tests only
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo test -p mermin-ebpf"

# Tests with output
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo test -- --nocapture"

# Integration tests
cd network-types/tests
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cd /app/network-types/tests && make build && cargo test"
```

### Code Quality

```bash
# Format code
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo fmt"

# Run clippy
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clippy -- -D warnings"

# Clippy for eBPF
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clippy -p mermin-ebpf -- -D warnings"
```

## eBPF Analysis

### Program Inspection

```bash
# List programs
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool prog list | grep mermin"

# Program details
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool prog show id <ID>"

# Count instructions
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool prog dump xlated id <ID> | grep -E '^[0-9]+:' | wc -l"
```

### Binary Analysis

```bash
# Count instructions in compiled binary
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "llvm-objdump -d /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test | grep -E '^[[:space:]]*[0-9a-f]+:' | wc -l"

# Binary size
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "ls -lh /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test"
```

## Kubernetes

### Local Development

```bash
# Create cluster
kind create cluster --config local/kind-config.yaml

# Build and load image
docker build -t mermin:latest --target runner-debug .
kind load docker-image -n atlantis mermin:latest

# Deploy
helm upgrade -i mermin charts/mermin --values local/values.yaml
```

### Management

```bash
# Check pods
kubectl get pods -l app.kubernetes.io/name=mermin

# View logs
kubectl logs -l app.kubernetes.io/name=mermin -f

# Debug network
kubectl debug -i -q <pod> --image=nicolaka/netshoot --target=mermin --profile=sysadmin -- tcpdump -i eth0 -w - | wireshark -k -i -
```

## Troubleshooting

### Build Issues

```bash
# Clean rebuild
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clean && cargo build"

# Check dependencies
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo tree"
```

### eBPF Issues

```bash
# Check verification logs
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "dmesg | grep -i 'bpf\|ebpf' | tail -20"

# Check maps
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool map list | grep mermin"
```

### K8s Issues

```bash
# Pod status
kubectl describe pod <pod-name>

# Events
kubectl get events --sort-by='.lastTimestamp' | grep mermin

# Helm status
helm list
helm get values mermin
```

## Common Workflows

### New Feature Development

```bash
# 1. Build and test
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build && cargo test"

# 2. Check eBPF impact
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build -p mermin-ebpf"

# 3. Run integration tests
cd network-types/tests
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cd /app/network-types/tests && make build && cargo test"
```

### Performance Optimization

```bash
# Before optimization
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "echo 'Before:' && llvm-objdump -d /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test | grep -E '^[[:space:]]*[0-9a-f]+:' | wc -l"

# After optimization
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "echo 'After:' && llvm-objdump -d /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test | grep -E '^[[:space:]]*[0-9a-f]+:' | wc -l"
```

## Important Notes

- **ALWAYS** use the Docker container for eBPF operations
- **NEVER** compile eBPF directly on non-Linux hosts
- **ALWAYS** check instruction counts after eBPF changes
- **ALWAYS** test in containerized environment first
- **ALWAYS** respect eBPF licensing requirements (GPL-2 or MIT)

# Quick Reference: Common Mermin Development Commands

## Essential Commands

### Setup

```bash
# Build development container
docker build -t mermin-builder:latest --target builder .

# Verify container
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo --version && bpftool --version"
```

### Building

```bash
# Clean build
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clean && cargo build"

# Release build
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build --release"

# Build specific crate
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build -p mermin-ebpf"
```

### Testing

```bash
# All tests
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo test"

# eBPF tests only
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo test -p mermin-ebpf"

# Tests with output
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo test -- --nocapture"

# Integration tests
cd network-types/tests
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cd /app/network-types/tests && make build && cargo test"
```

### Code Quality

```bash
# Format code
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo fmt"

# Run clippy
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clippy -- -D warnings"

# Clippy for eBPF
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clippy -p mermin-ebpf -- -D warnings"
```

## eBPF Analysis

### Program Inspection

```bash
# List programs
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool prog list | grep mermin"

# Program details
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool prog show id <ID>"

# Count instructions
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool prog dump xlated id <ID> | grep -E '^[0-9]+:' | wc -l"
```

### Binary Analysis

```bash
# Count instructions in compiled binary
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "llvm-objdump -d /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test | grep -E '^[[:space:]]*[0-9a-f]+:' | wc -l"

# Binary size
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "ls -lh /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test"
```

## Kubernetes

### Local Development

```bash
# Create cluster
kind create cluster --config local/kind-config.yaml

# Build and load image
docker build -t mermin:latest --target runner-debug .
kind load docker-image -n atlantis mermin:latest

# Deploy
helm upgrade -i mermin charts/mermin --values local/values.yaml
```

### Management

```bash
# Check pods
kubectl get pods -l app.kubernetes.io/name=mermin

# View logs
kubectl logs -l app.kubernetes.io/name=mermin -f

# Debug network
kubectl debug -i -q <pod> --image=nicolaka/netshoot --target=mermin --profile=sysadmin -- tcpdump -i eth0 -w - | wireshark -k -i -
```

## Troubleshooting

### Build Issues

```bash
# Clean rebuild
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo clean && cargo build"

# Check dependencies
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo tree"
```

### eBPF Issues

```bash
# Check verification logs
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "dmesg | grep -i 'bpf\|ebpf' | tail -20"

# Check maps
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "bpftool map list | grep mermin"
```

### K8s Issues

```bash
# Pod status
kubectl describe pod <pod-name>

# Events
kubectl get events --sort-by='.lastTimestamp' | grep mermin

# Helm status
helm list
helm get values mermin
```

## Common Workflows

### New Feature Development

```bash
# 1. Build and test
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build && cargo test"

# 2. Check eBPF impact
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cargo build -p mermin-ebpf"

# 3. Run integration tests
cd network-types/tests
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "cd /app/network-types/tests && make build && cargo test"
```

### Performance Optimization

```bash
# Before optimization
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "echo 'Before:' && llvm-objdump -d /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test | grep -E '^[[:space:]]*[0-9a-f]+:' | wc -l"

# After optimization
docker run -it --privileged --mount type=bind,source=.,target=/app mermin-builder:latest /bin/bash -c "echo 'After:' && llvm-objdump -d /app/target/debug/build/integration-*/out/integration-ebpf/bpfel-unknown-none/release/integration-ebpf-test | grep -E '^[[:space:]]*[0-9a-f]+:' | wc -l"
```

## Important Notes

- **ALWAYS** use the Docker container for eBPF operations
- **NEVER** compile eBPF directly on non-Linux hosts
- **ALWAYS** check instruction counts after eBPF changes
- **ALWAYS** test in containerized environment first
- **ALWAYS** respect eBPF licensing requirements (GPL-2 or MIT)
